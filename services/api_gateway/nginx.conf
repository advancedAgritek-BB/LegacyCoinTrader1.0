worker_processes 1;

events { worker_connections 1024; }

http {
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

  access_log /var/log/nginx/access.log main;
  error_log /var/log/nginx/error.log warn;

  upstream trading_engine {
    server trading-engine:8001;
  }
  upstream market_data {
    server market-data:8002;
  }
  upstream portfolio {
    server portfolio:8003;
  }
  upstream strategy_engine {
    server strategy-engine:8004;
  }
  upstream token_discovery {
    server token-discovery:8005;
  }
  upstream execution {
    server execution:8006;
  }
  upstream monitoring {
    server monitoring:8007;
  }

  map $http_authorization $auth_header {
    default $http_authorization;
  }

  server {
    listen 8081;
    server_name _;

    location /health {
      proxy_pass http://api-gateway:8000/health;
    }

    location /api/v1/trading {
      proxy_pass http://trading_engine;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/trading/ {
      proxy_pass http://trading_engine/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/market-data/ {
      proxy_pass http://market_data/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/portfolio/ {
      proxy_pass http://portfolio/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/strategy/ {
      proxy_pass http://strategy_engine/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/token-discovery/ {
      proxy_pass http://token_discovery/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/execution/ {
      proxy_pass http://execution/;
      include /etc/nginx/proxy_params;
    }

    location /api/v1/monitoring/ {
      proxy_pass http://monitoring/;
      include /etc/nginx/proxy_params;
    }
  }
}
