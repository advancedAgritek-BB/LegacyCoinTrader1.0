{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="welcome-section animate-fade-in">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h1 class="welcome-title">
                    <i class="fas fa-terminal" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-right: 16px;"></i>
                    System Logs
                </h1>
                <p class="welcome-subtitle">Real-time system log monitoring and analysis</p>
            </div>
            <div class="bot-controls">
                <div class="status-display">
                    <div class="badge bg-info" id="systemStatus">
                        <i class="fas fa-heartbeat"></i>
                        <span>System Online</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" onclick="refreshAllLogs()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh All
                    </button>
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: var(--font-sm);">
                        <input type="checkbox" id="autoRefresh" checked style="margin: 0;">
                        Auto-refresh (30s)
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Metrics -->
    <div class="metrics-grid animate-slide-up">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="metric-value" id="totalLogEntries">0</div>
            <div class="metric-label">Total Log Entries</div>
            <div class="metric-change info">
                <i class="fas fa-info-circle"></i>
                Last 24h
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-value" id="errorCount">0</div>
            <div class="metric-label">Errors</div>
            <div class="metric-change negative">
                <i class="fas fa-arrow-down"></i>
                -12%
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="metric-value" id="warningCount">0</div>
            <div class="metric-label">Warnings</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up"></i>
                +5%
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value" id="lastUpdate">Never</div>
            <div class="metric-label">Last Updated</div>
            <div class="metric-change info">
                <i class="fas fa-sync-alt"></i>
                Live
            </div>
        </div>
    </div>

    <!-- Log Filters -->
    <div class="card animate-slide-up animate-delay-100">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-filter"></i>
                Log Filters & Search
            </h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 16px; align-items: center;">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="logSearch" class="search-input" placeholder="Search logs..." onkeyup="filterLogs()">
                </div>
                <select id="logLevelFilter" onchange="filterLogs()" style="padding: 8px 16px; background: var(--glass-light); border: 1px solid var(--border-secondary); border-radius: var(--radius-md); color: var(--text-primary);">
                    <option value="">All Levels</option>
                    <option value="error">Errors</option>
                    <option value="warning">Warnings</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                </select>
                <button class="btn btn-outline-primary" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Grid -->
    <div class="logs-grid animate-slide-up animate-delay-200" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 24px; margin-top: 24px;">
        
        <!-- Trading Engine Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="tradingEngineStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-robot"></i>
                        Trading Engine
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('trading_engine')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="trading-engine-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading trading engine logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Service Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="portfolioStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-wallet"></i>
                        Portfolio Service
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('portfolio')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="portfolio-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading portfolio logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Data Service Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="marketDataStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-chart-line"></i>
                        Market Data
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('market_data')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="market-data-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading market data logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Engine Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="strategyEngineStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-brain"></i>
                        Strategy Engine
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('strategy_engine')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="strategy-engine-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading strategy engine logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Discovery Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="tokenDiscoveryStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-search"></i>
                        Token Discovery
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('token_discovery')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="token-discovery-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading token discovery logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- CEX Discovery Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="cexScannerStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-exchange-alt"></i>
                        CEX Listings
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('cex_scanner')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="cex-scanner-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading CEX discovery logs...
                    </div>
                </div>
            </div>
        </div>

        <!-- API Gateway Logs -->
        <div class="card log-section">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="status-indicator online" id="apiGatewayStatus"></div>
                    <h4 class="card-title" style="margin: 0;">
                        <i class="fas fa-gateway"></i>
                        API Gateway
                    </h4>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLog('api_gateway')">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="log-content" id="api-gateway-logs">
                    <div class="log-entry loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading API gateway logs...
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Enhanced Log Styles -->
<style>
.log-content {
    background: var(--bg-surface);
    border: 1px solid var(--border-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    font-family: var(--font-mono);
    font-size: var(--font-sm);
    max-height: 400px;
    overflow-y: auto;
    line-height: 1.6;
    position: relative;
    color: #f8fafc !important;
}

.log-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.log-entry {
    margin-bottom: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    word-wrap: break-word;
    font-size: var(--font-xs);
    line-height: 1.5;
    position: relative;
    color: #f8fafc !important;
}

.log-entry * {
    color: #f8fafc !important;
}

.log-entry, .log-entry span, .log-entry div {
    color: #f8fafc !important;
}

.log-entry:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateX(2px);
}

.log-entry.error {
    color: #fca5a5 !important;
    background: rgba(239, 68, 68, 0.1);
    border-left: 3px solid var(--danger);
    font-weight: 500;
}

.log-entry.warning {
    color: #fcd34d !important;
    background: rgba(245, 158, 11, 0.1);
    border-left: 3px solid var(--warning);
    font-weight: 500;
}

.log-entry.info {
    color: #67e8f9 !important;
    background: rgba(6, 182, 212, 0.1);
    border-left: 3px solid var(--info);
}

.log-entry.success {
    color: #6ee7b7 !important;
    background: rgba(16, 185, 129, 0.1);
    border-left: 3px solid var(--success);
}

.log-entry.evaluation-entry {
    border-left: 3px solid var(--primary);
    background: rgba(37, 99, 235, 0.12);
    color: #e2e8f0 !important;
}

.evaluation-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-xs);
}

.evaluation-symbol {
    font-size: 1.05rem;
    font-weight: 600;
    letter-spacing: 0.04em;
}

.evaluation-direction {
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
}

.evaluation-direction.direction-buy {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399 !important;
}

.evaluation-direction.direction-sell {
    background: rgba(248, 113, 113, 0.2);
    color: #f87171 !important;
}

.evaluation-direction.direction-none {
    background: rgba(148, 163, 184, 0.2);
    color: #cbd5f5 !important;
}

.evaluation-score {
    font-size: 1.1rem;
    font-weight: 600;
    color: #f8fafc !important;
}

.evaluation-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    margin-bottom: var(--space-xs);
    font-size: 0.75rem;
    color: #cbd5f5 !important;
}

.evaluation-meta span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(148, 163, 184, 0.15);
    padding: 2px 8px;
    border-radius: 999px;
}

.evaluation-signals {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: var(--space-xs);
}

.evaluation-signal-chip {
    background: rgba(59, 130, 246, 0.15);
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 0.7rem;
    letter-spacing: 0.04em;
    color: #bfdbfe !important;
}

.evaluation-metadata {
    margin-top: var(--space-xs);
    font-size: 0.72rem;
    color: #94a3b8 !important;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.evaluation-json {
    margin-top: var(--space-xs);
    white-space: pre-wrap;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: #cbd5f5 !important;
}

.log-entry.debug {
    color: #cbd5e1 !important;
    font-size: var(--font-xs);
    opacity: 0.8;
}

.log-entry:not(.error):not(.warning):not(.info):not(.success):not(.debug) {
    color: #f8fafc !important;
    background: rgba(255, 255, 255, 0.02);
}

.log-message {
    color: #f8fafc !important;
}

.log-timestamp {
    color: #94a3b8 !important;
}

/* Comprehensive override for all log text */
.log-content, .log-content *, 
.log-entry, .log-entry *, 
.log-message, .log-timestamp {
    color: #f8fafc !important;
}

.log-timestamp {
    color: #94a3b8 !important;
}

/* Ultra-aggressive text visibility fix */
#trading-engine-logs, #trading-engine-logs *,
#portfolio-logs, #portfolio-logs *,
#market-data-logs, #market-data-logs *,
#strategy-engine-logs, #strategy-engine-logs *,
#token-discovery-logs, #token-discovery-logs *,
#api-gateway-logs, #api-gateway-logs * {
    color: #ffffff !important;
    text-shadow: 0 0 1px rgba(255, 255, 255, 0.5) !important;
}

/* Force all div elements in log containers to be white */
div[id$="-logs"] div,
div[id$="-logs"] span,
div[id$="-logs"] * {
    color: #ffffff !important;
}

/* Nuclear option - force all text in log sections to be visible */
.card .log-content,
.card .log-content *,
.logs-grid .card *,
.logs-grid div,
.logs-grid span {
    color: #ffffff !important;
    text-shadow: 0 0 1px rgba(0, 0, 0, 0.5) !important;
}

.log-entry.loading {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    padding: var(--space-lg);
}

.log-entry.loading i {
    margin-right: var(--space-sm);
    color: var(--primary);
}

.log-timestamp {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-right: var(--space-sm);
    opacity: 0.7;
}

.log-level {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: var(--space-sm);
}

.log-level.error { background: var(--danger); color: white; }
.log-level.warning { background: var(--warning); color: white; }
.log-level.info { background: var(--info); color: white; }
.log-level.debug { background: var(--text-muted); color: white; }

.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input {
    background: var(--glass-light);
    border: 1px solid var(--border-secondary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md) var(--space-sm) 40px;
    color: var(--text-primary);
    font-size: var(--font-sm);
    transition: all var(--transition-fast);
    width: 100%;
}

.search-input:focus {
    outline: none;
    border-color: var(--border-accent);
    background: var(--glass-secondary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-icon {
    position: absolute;
    left: var(--space-md);
    color: var(--text-muted);
    font-size: var(--font-sm);
    z-index: 1;
}

.logs-grid .card {
    transition: all var(--transition-normal);
}

.logs-grid .card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.no-logs {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-muted);
}

.no-logs i {
    font-size: var(--font-3xl);
    margin-bottom: var(--space-lg);
    opacity: 0.5;
}

/* Custom scrollbar for log content */
.log-content::-webkit-scrollbar {
    width: 6px;
}

.log-content::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 3px;
}

.log-content::-webkit-scrollbar-thumb {
    background: var(--border-secondary);
    border-radius: 3px;
    transition: background var(--transition-fast);
}

.log-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .logs-grid {
        grid-template-columns: 1fr !important;
    }
    
    .log-content {
        max-height: 300px;
        font-size: var(--font-xs);
    }
    
    .search-container {
        margin-bottom: var(--space-md);
    }
}

/* EMERGENCY OVERRIDE - ABSOLUTE HIGHEST SPECIFICITY */
html body .logs-grid .card .log-content,
html body .logs-grid .card .log-content *,
html body .logs-grid .card .log-content div,
html body .logs-grid .card .log-content span,
html body .logs-grid .card .log-content .log-entry,
html body .logs-grid .card .log-content .log-message {
    color: #ffffff !important;
    background-color: transparent !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8) !important;
}

/* Force specific log containers */
html body #trading-engine-logs,
html body #portfolio-logs,
html body #market-data-logs,
html body #strategy-engine-logs,
html body #token-discovery-logs,
html body #cex-scanner-logs,
html body #api-gateway-logs {
    color: #ffffff !important;
}

html body #trading-engine-logs *,
html body #portfolio-logs *,
html body #market-data-logs *,
html body #strategy-engine-logs *,
html body #token-discovery-logs *,
html body #cex-scanner-logs *,
html body #api-gateway-logs * {
    color: #ffffff !important;
    background-color: transparent !important;
}

/* Nuclear option - override everything */
.logs-grid * {
    color: #ffffff !important;
}

.log-content * {
    color: #ffffff !important;
}

/* Ensure timestamps remain distinguishable */
.log-timestamp {
    color: #94a3b8 !important;
}
</style>

<!-- Enhanced JavaScript -->
<script>
let autoRefreshInterval;
let autoRefreshEnabled = true;
let logFilters = {
    search: '',
    level: ''
};

// Log data storage
let logData = {};

const simulatedStrategyPatterns = [
    /strategy engine starting/i,
    /loading trading strategies/i,
    /✅ loaded .* strategy/i,
    /strategy engine ready/i,
    /analyzing market conditions/i,
    /momentum signal:/i,
    /mean reversion signal:/i,
    /breakout signal:/i,
    /combined signal:/i,
    /low liquidity detected/i,
    /market volatility:/i,
    /risk assessment:/i,
    /strategy performance review/i,
    /fallback to previous signal/i,
];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeLogsPage();
    setupEventListeners();
    
    // Add debug logging
    console.log('Logs page initialized, attempting to fetch logs...');
    
    // Try to load logs immediately
    refreshAllLogs();
    
    // EMERGENCY: Force all text to be visible immediately
    setTimeout(() => {
        const logContainers = document.querySelectorAll('[id$="-logs"]');
        logContainers.forEach(container => {
            forceTextVisibility(container);
        });
    }, 100);
    
    // Also force visibility every 2 seconds as a safety net
    setInterval(() => {
        const logContainers = document.querySelectorAll('[id$="-logs"]');
        logContainers.forEach(container => {
            forceTextVisibility(container);
        });
    }, 2000);
});

function initializeLogsPage() {
    // Set active nav item
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        if (link.getAttribute('href') === '/logs') {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}

function setupEventListeners() {
    // Auto-refresh toggle
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    if (autoRefreshCheckbox) {
        autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
        if (autoRefreshCheckbox.checked) {
            startAutoRefresh();
        }
    }

    // Search input
    const searchInput = document.getElementById('logSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterLogs, 300));
    }
}

function shouldSkipLogLine(logType, line) {
    if (!line || typeof line !== 'string') {
        return false;
    }
    if (logType !== 'strategy_engine') {
        return false;
    }
    const normalized = line.toLowerCase();
    return simulatedStrategyPatterns.some((pattern) => pattern.test(normalized));
}

function extractTimestamp(value) {
    if (!value) {
        return null;
    }
    if (typeof value === 'object' && value.timestamp) {
        const parsed = new Date(value.timestamp);
        return Number.isNaN(parsed.valueOf()) ? null : parsed;
    }
    if (typeof value === 'string') {
        const match = value.match(/(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2}:\d{2})/);
        if (match) {
            const isoGuess = `${match[1]}T${match[2]}Z`;
            const parsed = new Date(isoGuess);
            return Number.isNaN(parsed.valueOf()) ? null : parsed;
        }
    }
    return null;
}

function isStaleStrategyEntry(logType, line) {
    if (logType !== 'strategy_engine') {
        return false;
    }
    const timestamp = extractTimestamp(line);
    if (!timestamp) {
        return false;
    }
    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
    return Date.now() - timestamp.valueOf() > sevenDaysMs;
}

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value).replace(/[&<>"'`=\\/]/g, (char) => {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '`': '&#96;',
            '=': '&#61;',
            '/': '&#47;',
            '\\': '&#92;'
        };
        return map[char] || char;
    });
}

function formatPlainLogEntry(line, timestamp = null) {
    if (!line || line.trim() === '') return '';

    const classes = [];
    let level = '';
    const lower = line.toLowerCase();

    if (lower.includes('error') || line.includes('❌')) {
        classes.push('error');
        level = 'error';
    } else if (lower.includes('warning') || line.includes('⚠️')) {
        classes.push('warning');
        level = 'warning';
    } else if (lower.includes('debug') || line.includes('🔍')) {
        classes.push('debug');
        level = 'debug';
    } else if (lower.includes('success') || line.includes('✅')) {
        classes.push('success');
        level = 'info';
    } else if (lower.includes('info')) {
        classes.push('info');
        level = 'info';
    }

    const timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})/);
    const extractedTimestamp = timestampMatch ? timestampMatch[1] : timestamp;
    let cleanLine = line;
    if (timestampMatch) {
        cleanLine = line.replace(timestampMatch[0], '').trim();
    }

    const normalizedContent = cleanLine.toLowerCase();

    return `
        <div class="log-entry ${classes.join(' ')}" data-level="${level}" data-content="${escapeHtml(normalizedContent)}" style="color: #ffffff !important;">
            ${extractedTimestamp ? `<span class="log-timestamp" style="color: #94a3b8 !important;">${escapeHtml(extractedTimestamp)}</span>` : ''}
            ${level ? `<span class="log-level ${level}" style="color: #ffffff !important;">${escapeHtml(level.toUpperCase())}</span>` : ''}
            <span class="log-message" style="color: #ffffff !important;">${escapeHtml(cleanLine)}</span>
        </div>
    `;
}

function formatStructuredLogEntry(data) {
    if (!data || typeof data !== 'object') {
        return formatPlainLogEntry(JSON.stringify(data));
    }

    const severity = (data.level || 'info').toString().toLowerCase();
    const level = ['error', 'warning', 'info', 'debug', 'success'].includes(severity) ? severity : 'info';
    const classes = level ? [level] : [];

    let displayTimestamp = '';
    if (data.timestamp) {
        const parsed = new Date(data.timestamp);
        displayTimestamp = Number.isNaN(parsed.valueOf()) ? data.timestamp : parsed.toLocaleString();
    }

    const message = data.message || 'log_event';
    const searchTokens = [message, level];
    let bodyHtml = '';

    if (message === 'strategy_evaluation_completed') {
        classes.push('evaluation-entry');
        const symbol = data.symbol || data.asset || 'UNKNOWN';
        const directionRaw = (data.direction || 'none').toString().toLowerCase();
        const directionClass = ['buy', 'sell', 'none'].includes(directionRaw) ? directionRaw : 'none';
        const directionLabel = directionRaw.toUpperCase();
        const scoreValue = Number.isFinite(Number(data.score)) ? Number(data.score).toFixed(2) : 'N/A';
        const fusedScore = Number.isFinite(Number(data.fused_score)) ? Number(data.fused_score).toFixed(2) : null;
        const fusedDirection = data.fused_direction ? data.fused_direction.toString().toUpperCase() : null;
        const mode = data.mode || 'auto';
        const regime = data.regime || 'unspecified';
        const cacheBadge = data.cached ? 'Cache hit' : 'Fresh evaluation';
        const source = data.source || (data.cached ? 'cache' : 'fresh');
        const topSignals = Array.isArray(data.top_ranked_signals) ? data.top_ranked_signals.slice(0, 3) : [];

        const signalsHtml = topSignals.length
            ? topSignals
                .map((signal) => {
                    const strategy = signal && signal.strategy ? signal.strategy : 'unknown';
                    const sigScore = Number.isFinite(Number(signal && signal.score)) ? Number(signal.score).toFixed(2) : 'N/A';
                    const sigDirection = signal && signal.direction ? signal.direction.toString().toUpperCase() : 'N/A';
                    return `<span class="evaluation-signal-chip">${escapeHtml(strategy)} | ${escapeHtml(sigScore)} | ${escapeHtml(sigDirection)}</span>`;
                })
                .join('')
            : '<span class="evaluation-signal-chip">No ranked signals</span>';

        const metadata = (data.metadata && typeof data.metadata === 'object') ? data.metadata : {};
        const preferredMetadataKeys = ['evaluation_mode', 'reason', 'evaluated_at'];
        let metadataPairs = preferredMetadataKeys
            .map((key) => (metadata[key] ? [key, metadata[key]] : null))
            .filter(Boolean);
        if (metadataPairs.length === 0) {
            metadataPairs = Object.entries(metadata).slice(0, 2);
        }

        const metadataHtml = metadataPairs.length
            ? `<div class="evaluation-metadata">${metadataPairs
                .map(([key, value]) => `<span>${escapeHtml(key)}: ${escapeHtml(value)}</span>`)
                .join('')}</div>`
            : '';

        const fusedHtml = fusedScore && fusedDirection
            ? `<div class="evaluation-metadata"><span>Fused signal: ${escapeHtml(fusedScore)} (${escapeHtml(fusedDirection)})</span></div>`
            : '';

        bodyHtml = `
            <div class="evaluation-header">
                <div class="evaluation-symbol">${escapeHtml(symbol)}</div>
                <div class="evaluation-direction direction-${escapeHtml(directionClass)}">${escapeHtml(directionLabel)}</div>
                <div class="evaluation-score">${escapeHtml(scoreValue)}</div>
            </div>
            <div class="evaluation-meta">
                <span><i class="fas fa-layer-group"></i> ${escapeHtml(regime)}</span>
                <span><i class="fas fa-cog"></i> ${escapeHtml(mode)}</span>
                <span><i class="fas fa-database"></i> ${escapeHtml(cacheBadge)}</span>
                <span><i class="fas fa-satellite-dish"></i> ${escapeHtml(source)}</span>
            </div>
            ${fusedHtml}
            ${metadataHtml}
            <div class="evaluation-signals">${signalsHtml}</div>
        `;

        searchTokens.push(symbol, directionLabel, scoreValue, mode, regime, cacheBadge, source);
        if (metadataPairs.length) {
            metadataPairs.forEach(([key, value]) => {
                searchTokens.push(`${key}:${value}`);
            });
        }
    } else {
        bodyHtml = `<div class="evaluation-json">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
        searchTokens.push(JSON.stringify(data));
    }

    const contentValue = escapeHtml(searchTokens.join(' ').toLowerCase());

    return `
        <div class="log-entry ${classes.join(' ')}" data-level="${escapeHtml(level)}" data-content="${contentValue}" style="color: #ffffff !important;">
            ${displayTimestamp ? `<span class="log-timestamp" style="color: #94a3b8 !important;">${escapeHtml(displayTimestamp)}</span>` : ''}
            <span class="log-message" style="color: #ffffff !important; text-transform: capitalize;">${escapeHtml(message.replace(/_/g, ' '))}</span>
            ${bodyHtml}
        </div>
    `;
}

// Format log entry with enhanced styling
function formatLogEntry(line, timestamp = null) {
    if (line === null || line === undefined) return '';

    if (typeof line === 'object') {
        return formatStructuredLogEntry(line);
    }

    const trimmed = line.trim();
    if (trimmed.startsWith('{')) {
        try {
            const parsed = JSON.parse(trimmed);
            return formatStructuredLogEntry(parsed);
        } catch (err) {
            // Fall back to plain log formatting when parsing fails
        }
    }

    return formatPlainLogEntry(line, timestamp);
}

// Update log content with enhanced display
function updateLogContent(logType, lines) {
    const containerId = `${logType.replace(/_/g, '-')}-logs`;
    const container = document.getElementById(containerId);
    
    console.log(`Updating log content for ${logType} -> ${containerId}`, lines);
    
    if (!container) {
        console.warn(`Log container not found: ${containerId}`);
        return;
    }

    const sourceLines = Array.isArray(lines) ? lines : [];

    const sanitizedLines = sourceLines.filter(line => {
        if (line === null || line === undefined) {
            return false;
        }
        if (isStaleStrategyEntry(logType, line)) {
            return false;
        }
        if (typeof line === 'string') {
            if (line.trim() === '') {
                return false;
            }
            if (shouldSkipLogLine(logType, line)) {
                return false;
            }
        }
        return true;
    });

    // Store log data for filtering and metrics
    logData[logType] = sanitizedLines;

    if (sanitizedLines.length > 0) {
        console.log(`Processing ${sanitizedLines.length} log entries for ${logType}`);
        
        const formattedEntries = sanitizedLines
            .map(line => formatLogEntry(line))
            .filter(entry => entry !== '');
            
        console.log(`Formatted ${formattedEntries.length} entries for ${logType}`);
        
        if (formattedEntries.length > 0) {
            container.innerHTML = formattedEntries.join('');
            console.log(`Updated ${containerId} with real log data`);
        } else {
            container.innerHTML = '<div class="no-logs" style="color: #ffffff !important;"><i class="fas fa-file-alt"></i><p>No valid log entries found</p></div>';
        }
    } else {
        if (logType === 'strategy_engine' && sourceLines.length > 0) {
            container.innerHTML = [
                '<div class="no-logs" style="color: #ffffff !important;">',
                '<i class="fas fa-info-circle"></i>',
                '<p>Only simulated strategy logs were found. Real evaluations have not been written yet. ',
                'Once the strategy engine runs and emits fresh entries, they will appear here.</p>',
                '</div>'
            ].join('');
        } else {
            container.innerHTML = '<div class="no-logs" style="color: #ffffff !important;"><i class="fas fa-file-alt"></i><p>No log entries available</p></div>';
        }
        console.log(`No log entries found for ${logType}`);
    }

    // EMERGENCY: Force all text to be white after DOM update
    setTimeout(() => {
        forceTextVisibility(container);
        console.log(`Forced text visibility for ${containerId}`);
    }, 10);

    // Apply current filters
    applyFiltersToContainer(container);
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
    
    // Update metrics
    updateLogMetrics();
}

// Emergency function to force text visibility
function forceTextVisibility(container) {
    if (!container) return;
    
    // Force color on container and all children
    container.style.color = '#ffffff';
    container.style.setProperty('color', '#ffffff', 'important');
    
    const allElements = container.querySelectorAll('*');
    allElements.forEach(element => {
        element.style.color = '#ffffff';
        element.style.setProperty('color', '#ffffff', 'important');
    });
    
    // Special handling for timestamps
    const timestamps = container.querySelectorAll('.log-timestamp');
    timestamps.forEach(ts => {
        ts.style.color = '#94a3b8';
        ts.style.setProperty('color', '#94a3b8', 'important');
    });
}

        // Refresh specific log
        async function refreshLog(logType) {
            const button = document.querySelector(`button[onclick="refreshLog('${logType}')"]`);
            if (button) {
                const icon = button.querySelector('i');
                if (icon) {
                    icon.classList.add('fa-spin');
                }
            }

            try {
                const response = await fetch('/api/monitoring/logs');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data[logType]) {
                    updateLogContent(logType, result.data[logType]);
                } else {
                    console.warn(`No data found for log type: ${logType}`);
                    const containerId = `${logType.replace(/_/g, '-')}-logs`;
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `<div class="log-entry warning">No log data available for ${logType}</div>`;
                    }
                }
            } catch (error) {
                console.error(`Error refreshing ${logType} log:`, error);
                const containerId = `${logType.replace(/_/g, '-')}-logs`;
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<div class="log-entry error">Error loading logs: ${error.message}</div>`;
                }
            } finally {
                if (button) {
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-spin');
                    }
                }
            }
        }

// Refresh all logs
async function refreshAllLogs() {
    console.log('Attempting to fetch logs from /api/monitoring/logs...');
    
    try {
        const response = await fetch('/api/monitoring/logs');
        console.log('Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('API Response:', result);
        
        if (result.success) {
            console.log('Successfully received log data:', Object.keys(result.data));
            
            // Update each log type
            Object.keys(result.data).forEach(logType => {
                console.log(`Updating ${logType} with ${result.data[logType].length} entries`);
                updateLogContent(logType, result.data[logType]);
            });
            
            // Update last update time
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = new Date().toLocaleTimeString();
            }
            
            // Update system status
            updateSystemStatus();
            
            console.log(`Successfully loaded logs for ${Object.keys(result.data).length} services`);
        } else {
            console.error('API returned success=false:', result.error);
            // Show error in all log containers
            document.querySelectorAll('.log-content').forEach(container => {
                container.innerHTML = `<div class="log-entry error" style="color: #ffffff !important;">API Error: ${result.error}</div>`;
                forceTextVisibility(container);
            });
        }
    } catch (error) {
        console.error('Error refreshing all logs:', error);
        // Show connection error in all log containers
        document.querySelectorAll('.log-content').forEach(container => {
            container.innerHTML = `<div class="log-entry error" style="color: #ffffff !important;">Connection Error: ${error.message}<br><br>Make sure the frontend server is running and accessible.</div>`;
            forceTextVisibility(container);
        });
    }
}

// Update system status indicators
function updateSystemStatus() {
    // This would typically fetch real status data
    // For now, we'll assume services are online if we can fetch logs
    const statusElements = [
        'tradingEngineStatus', 'portfolioStatus', 'marketDataStatus',
        'strategyEngineStatus', 'tokenDiscoveryStatus', 'cexScannerStatus',
        'apiGatewayStatus'
    ];
    
    statusElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.className = 'status-indicator online';
        }
    });
}

// Update log metrics
function updateLogMetrics() {
    let totalEntries = 0;
    let errorCount = 0;
    let warningCount = 0;
    
    Object.values(logData).forEach(logs => {
        if (Array.isArray(logs)) {
            totalEntries += logs.length;
            logs.forEach(log => {
                let logLower = '';
                if (typeof log === 'string') {
                    logLower = log.toLowerCase();
                } else if (log && typeof log === 'object') {
                    try {
                        logLower = JSON.stringify(log).toLowerCase();
                    } catch (err) {
                        logLower = '';
                    }
                }
                if (logLower.includes('error') || logLower.includes('❌')) {
                    errorCount++;
                } else if (logLower.includes('warning') || logLower.includes('⚠️')) {
                    warningCount++;
                }
            });
        }
    });
    
    // Update metric displays
    const totalElement = document.getElementById('totalLogEntries');
    if (totalElement) totalElement.textContent = totalEntries.toLocaleString();
    
    const errorElement = document.getElementById('errorCount');
    if (errorElement) errorElement.textContent = errorCount.toLocaleString();
    
    const warningElement = document.getElementById('warningCount');
    if (warningElement) warningElement.textContent = warningCount.toLocaleString();
}

// Filter logs based on search and level
function filterLogs() {
    const searchInput = document.getElementById('logSearch');
    const levelFilter = document.getElementById('logLevelFilter');
    
    logFilters.search = searchInput ? searchInput.value.toLowerCase() : '';
    logFilters.level = levelFilter ? levelFilter.value : '';
    
    // Apply filters to all log containers
    document.querySelectorAll('.log-content').forEach(container => {
        applyFiltersToContainer(container);
    });
}

function applyFiltersToContainer(container) {
    const entries = container.querySelectorAll('.log-entry');
    
    entries.forEach(entry => {
        const content = entry.getAttribute('data-content') || '';
        const level = entry.getAttribute('data-level') || '';
        
        let show = true;
        
        // Apply search filter
        if (logFilters.search && !content.includes(logFilters.search)) {
            show = false;
        }
        
        // Apply level filter
        if (logFilters.level && level !== logFilters.level) {
            show = false;
        }
        
        entry.style.display = show ? 'block' : 'none';
    });
}

// Clear all filters
function clearFilters() {
    const searchInput = document.getElementById('logSearch');
    const levelFilter = document.getElementById('logLevelFilter');
    
    if (searchInput) searchInput.value = '';
    if (levelFilter) levelFilter.value = '';
    
    logFilters = { search: '', level: '' };
    filterLogs();
}

// Auto-refresh functionality
function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    autoRefreshEnabled = checkbox ? checkbox.checked : false;

    if (autoRefreshEnabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    stopAutoRefresh(); // Clear any existing interval
    autoRefreshInterval = setInterval(refreshAllLogs, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
