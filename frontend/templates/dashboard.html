{% extends 'base.html' %}
{% block content %}
<div class="row mb-4">
  <div class="col">
    <div class="card">
      <div class="card-header">Trade Dashboard</div>
      <div class="card-body">
        <p class="mb-3"><strong>Total PnL:</strong> ${{ "%.2f"|format(pnl) }}</p>
        <div class="row">
          <div class="col-md-6"><canvas id="perfChart"></canvas></div>
          <div class="col-md-6"><canvas id="allocChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Recent Regimes</div>
      <div class="card-body p-2">
        <ul class="mb-0">
          {% for r in regimes %}
          <li>{{ r }}</li>
          {% else %}
          <li>No data</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Strategy Allocation Details <span class="badge bg-success">Fixed</span></div>
      <div class="card-body p-2">
        <small class="text-muted">
          <strong>Fixed:</strong> Allocation now uses actual performance data instead of static config values.
          <br><br>
          Allocation is calculated dynamically based on:
          <ul class="mb-0 mt-1">
            <li>Win rate (40% weight)</li>
            <li>PnL per trade (40% weight)</li>
            <li>Trade volume (20% weight)</li>
          </ul>
        </small>
        {% if allocation %}
        <div class="mt-2">
          <strong>Dynamic Allocation (Performance-Based):</strong>
          <ul class="mb-0 mt-1">
            {% for strategy, percentage in allocation.items() %}
            <li>{{ strategy }}: {{ "%.1f"|format(percentage) }}%</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<h2 class="mt-4">Recent Regimes</h2>
<ul>
  {% for r in regimes %}
  <li>{{ r }}</li>
  {% else %}
  <li>No data</li>
  {% endfor %}
</ul>
<h2 class="mt-4">Live Signals</h2>
<div id="signalsHeatmap"></div>
<h2 class="mt-4">Regime Breakdown</h2>
<div id="regimeBreakdown"></div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const perfData = {{ performance['per_symbol']|tojson if performance and performance.get('per_symbol') else '{}' }};
const allocData = {{ allocation|tojson }};

// Performance chart
if (Object.keys(perfData).length > 0) {
    new Chart(document.getElementById('perfChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(perfData), 
            datasets: [{
                label: 'PnL', 
                data: Object.values(perfData), 
                backgroundColor: 'rgba(54,162,235,0.6)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
} else {
    document.getElementById('perfChart').innerHTML = '<p class="text-muted text-center">No performance data available</p>';
}

// Allocation chart
if (Object.keys(allocData).length > 0) {
    new Chart(document.getElementById('allocChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(allocData), 
            datasets: [{
                data: Object.values(allocData), 
                backgroundColor: ['#ff6384','#36a2eb','#ffcd56','#4bc0c0','#9966ff','#c9cbcf']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
} else {
    document.getElementById('allocChart').innerHTML = '<p class="text-muted text-center">No allocation data available</p>';
}

function color(val){
  const g = Math.floor(255 * val);
  const r = 255 - g;
  return `rgb(${r},${g},0)`;
}

// Live signals
fetch('/api/live-signals')
.then(r => r.json())
.then(data => {
  const cont = document.getElementById('signalsHeatmap');
  if (!Object.keys(data).length) {
    cont.innerText = 'No live signals available';
    return;
  }
  let html = '<table class="table table-bordered"><tbody><tr>';
  for (const [sym, val] of Object.entries(data)) {
    html += `<td style="background-color:${color(val)}">${sym}<br>${val.toFixed(2)}</td>`;
  }
  html += '</tr></tbody></table>';
  cont.innerHTML = html;
})
.catch(error => {
  document.getElementById('signalsHeatmap').innerHTML = '<p class="text-muted">Error loading live signals</p>';
});

// Strategy performance
fetch('/api/strategy-performance')
.then(r => r.json())
.then(data => {
  const cont = document.getElementById('regimeBreakdown');
  if (!Object.keys(data).length) {
    cont.innerText = 'No strategy performance data available';
    return;
  }
  let html = '';
  for (const [regime, strategies] of Object.entries(data)) {
    html += `<h5>${regime}</h5><ul>`;
    for (const [s, recs] of Object.entries(strategies)) {
      html += `<li>${s}: ${recs.length} trades</li>`;
    }
    html += '</ul>';
  }
  cont.innerHTML = html;
})
.catch(error => {
  document.getElementById('regimeBreakdown').innerHTML = '<p class="text-muted">Error loading strategy performance</p>';
});
</script>
{% endblock %}
