{% extends "base.html" %}

{% block content %}
<div class="dashboard-container fade-in">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <i class="fas fa-exchange-alt"></i>
      <h1>Trading History</h1>
    </div>
    <div class="page-description">
      Complete overview of your trading activity and performance
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="metrics-grid">
    <div class="metric-card ai-card">
      <div class="metric-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="metric-content">
        <h3>Total Trades</h3>
        <div class="metric-value ai-gradient" id="totalTradesCount">0</div>
        <div class="metric-change">
          <i class="fas fa-history"></i>
          All time
        </div>
      </div>
    </div>
    
    <div class="metric-card ai-card">
      <div class="metric-icon">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <div class="metric-content">
        <h3>Total Volume</h3>
        <div class="metric-value ai-gradient" id="totalVolume">$0.00</div>
        <div class="metric-change">
          <i class="fas fa-chart-area"></i>
          Trading volume
        </div>
      </div>
    </div>
    
    <div class="metric-card ai-card">
      <div class="metric-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="metric-content">
        <h3>Win Rate</h3>
        <div class="metric-value ai-gradient" id="winRate">0%</div>
        <div class="metric-change">
          <i class="fas fa-percentage"></i>
          Success ratio
        </div>
      </div>
    </div>
    
    <div class="metric-card ai-card" id="realizedPnlCard">
      <div class="metric-icon">
        <i class="fas fa-coins"></i>
      </div>
      <div class="metric-content">
        <h3>Realized P&L</h3>
        <div class="metric-value ai-gradient" id="realizedPnl">$0.00</div>
        <div class="metric-change">
          <i class="fas fa-check-circle"></i>
          Closed positions
        </div>
      </div>
    </div>
    
    <div class="metric-card ai-card" id="unrealizedPnlCard">
      <div class="metric-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="metric-content">
        <h3>Unrealized P&L</h3>
        <div class="metric-value ai-gradient" id="unrealizedPnl">$0.00</div>
        <div class="metric-change">
          <i class="fas fa-hourglass-half"></i>
          Open positions
        </div>
      </div>
    </div>
    
    <div class="metric-card ai-card" id="totalPnlCard">
      <div class="metric-icon">
        <i class="fas fa-balance-scale"></i>
      </div>
      <div class="metric-content">
        <h3>Total P&L</h3>
        <div class="metric-value ai-gradient" id="totalPnl">$0.00</div>
        <div class="metric-change">
          <i class="fas fa-calculator"></i>
          Net result
        </div>
      </div>
    </div>
  </div>

  <!-- Trades Table Card -->
  <div class="card ai-card">
    <div class="card-header">
      <div class="card-header-content">
        <h5 class="card-title">
          <i class="fas fa-list"></i>
          Recent Trades
        </h5>
        <div class="card-actions">
          <button class="btn btn-outline-primary btn-sm" onclick="refreshTrades()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="exportTrades()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      
      <!-- Search and Filters -->
      <div class="card-filters">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="tradeSearch" placeholder="Search trades...">
        </div>
      </div>
    </div>
    
    <div class="card-body">
      <div class="table-container">
        <div class="table-responsive">
          <table class="table modern-table" id="tradesTable">
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>Symbol</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Price</th>
                <th>Total</th>
                <th>P&L</th>
                <th>P&L %</th>
                <th>Current Price</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tradesTableBody">
              <!-- Loading state -->
              <tr class="loading-row">
                <td colspan="11" class="text-center py-4">
                  <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <div class="mt-2">Loading trades...</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Errors Section -->
  <div class="card ai-card mt-4">
    <div class="card-header">
      <div class="card-header-content">
        <h5 class="card-title">
          <i class="fas fa-exclamation-triangle"></i>
          Recent Errors
        </h5>
      </div>
    </div>
    <div class="card-body">
      <div class="errors-container" id="errorsContainer">
        <!-- Errors will be loaded here -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let tradesData = [];
let errorsData = [];

// Initialize the trades page
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing trades page');
  loadTrades();
  loadErrors();
  
  // Set up search functionality
  const searchInput = document.getElementById('tradeSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      filterTrades(e.target.value);
    });
  }
});

// Load trades data
function loadTrades() {
  // Remove loading row if it exists
  const loadingRow = document.querySelector('.loading-row');
  if (loadingRow) {
    loadingRow.remove();
  }
  
  fetch('/trades_data')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Trades data received:', data);
      tradesData = data || [];
      console.log('Trades data length:', tradesData.length);
      displayTrades(tradesData);
      updateSummary(tradesData);
    })
    .catch(error => {
      console.error('Error loading trades:', error);
      // Display empty state
      displayTrades([]);
      updateSummary([]);
    });
}

// Load errors
function loadErrors() {
  fetch('/trades_tail')
    .then(response => response.json())
    .then(data => {
      if (data.errors) {
        displayErrors(data.errors);
      }
    })
    .catch(error => {
      console.error('Error loading errors:', error);
    });
}

// Display trades in the table
function displayTrades(trades) {
  console.log('displayTrades called with:', trades);
  const tbody = document.getElementById('tradesTableBody');
  if (!tbody) {
    console.error('tradesTableBody not found');
    return;
  }
  
  tbody.innerHTML = '';
  
  if (trades.length === 0) {
    console.log('No trades to display');
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="11" class="text-center py-5">
          <div class="empty-state-content">
            <i class="fas fa-chart-line fa-3x mb-3 text-muted"></i>
            <h5>No trades found</h5>
            <p class="text-muted">Your trading history will appear here once you start trading</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  trades.forEach(trade => {
    const row = createTradeRow(trade);
    tbody.appendChild(row);
  });
}

// Create a trade table row
function createTradeRow(trade) {
  const row = document.createElement('tr');
  row.classList.add('trade-row');
  
  // Format the trade data
  const date = new Date(trade.timestamp || trade.date || Date.now()).toLocaleString();
  const symbol = trade.symbol || trade.pair || 'N/A';
  const type = trade.side || trade.type || 'N/A';
  const amount = trade.amount || trade.quantity || 0;
  const price = trade.price || trade.execution_price || 0;
  const total = amount * price;
  const status = trade.status || 'completed';
  
  // Get PnL values
  const pnl = trade.pnl || 0;
  const pnlPercentage = trade.pnl_percentage || 0;
  const unrealizedPnl = trade.unrealized_pnl || 0;
  const unrealizedPnlPercentage = trade.unrealized_pnl_percentage || 0;
  const currentPrice = trade.current_price || 0;
  
  // Determine status badge class
  let statusClass = 'trade-status open';
  if (status === 'completed') statusClass = 'trade-status closed';
  else if (status === 'active') statusClass = 'trade-status open';
  else if (status === 'failed') statusClass = 'trade-status closed';
  else if (status === 'pending') statusClass = 'trade-status open';
  
  // Determine type badge class
  let typeClass = 'trade-status';
  if (type.toLowerCase() === 'buy') typeClass = 'trade-status buy';
  else if (type.toLowerCase() === 'sell') typeClass = 'trade-status sell';
  
  // Determine PnL styling
  let pnlClass = 'pnl-neutral';
  let pnlValue = pnl;
  let pnlPercentValue = pnlPercentage;
  
  // For completed trades, show realized P&L
  // For active trades, show unrealized P&L if available
  if (status === 'active' && unrealizedPnl !== 0) {
    pnlValue = unrealizedPnl;
    pnlPercentValue = unrealizedPnlPercentage;
  }
  
  if (pnlValue > 0) {
    pnlClass = 'pnl-positive';
  } else if (pnlValue < 0) {
    pnlClass = 'pnl-negative';
  }
  
  row.innerHTML = `
    <td class="date-cell">${date}</td>
    <td class="symbol-cell"><strong>${symbol}</strong></td>
    <td><span class="${typeClass}">${type.toUpperCase()}</span></td>
    <td class="amount-cell">${formatNumber(amount)}</td>
    <td class="price-cell">${formatCurrency(price)}</td>
    <td class="total-cell">${formatCurrency(total)}</td>
    <td class="pnl-cell ${pnlClass}">${formatCurrency(pnlValue)}</td>
    <td class="pnl-percent-cell ${pnlClass}">${pnlPercentValue.toFixed(2)}%</td>
    <td class="current-price-cell">${formatCurrency(currentPrice)}</td>
    <td><span class="${statusClass}">${status}</span></td>
    <td class="actions-cell">
      <button class="btn-action" onclick="viewTradeDetails('${trade.id || trade.timestamp}')" title="View Details">
        <i class="fas fa-eye"></i>
      </button>
    </td>
  `;
  
  return row;
}

// Display errors
function displayErrors(errors) {
  const container = document.getElementById('errorsContainer');
  if (!container) return;
  
  if (!errors || errors.trim() === '') {
    container.innerHTML = `
      <div class="empty-state-content text-center py-3">
        <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
        <h6>No errors found</h6>
        <p class="text-muted mb-0">System is running smoothly</p>
      </div>
    `;
    return;
  }
  
  const errorLines = errors.split('\n').filter(line => line.trim());
  let html = '';
  
  errorLines.forEach(line => {
    if (line.trim()) {
      html += `
        <div class="error-item">
          <i class="fas fa-exclamation-circle text-danger"></i>
          <span class="error-text">${line}</span>
        </div>
      `;
    }
  });
  
  container.innerHTML = html;
}

// Update summary statistics
function updateSummary(trades) {
  const totalTrades = trades.length;
  const totalVolume = trades.reduce((sum, trade) => {
    const amount = trade.amount || trade.quantity || 0;
    const price = trade.price || trade.execution_price || 0;
    return sum + (amount * price);
  }, 0);
  
  // Calculate realized and unrealized P&L
  let realizedPnl = 0;
  let unrealizedPnl = 0;
  let completedTrades = 0;
  let winningTrades = 0;
  
  trades.forEach(trade => {
    const tradePnl = trade.pnl || 0;
    const unrealizedTradePnl = trade.unrealized_pnl || 0;
    
    // Accumulate P&L
    realizedPnl += tradePnl;
    unrealizedPnl += unrealizedTradePnl;
    
    // Count completed trades for win rate calculation
    if (trade.status === 'completed' && trade.side === 'sell') {
      completedTrades++;
      // Count winning trades (trades that made profit)
      if (tradePnl > 0) {
        winningTrades++;
      }
    }
  });
  
  // Calculate win rate based on completed sell trades only
  const winRate = completedTrades > 0 ? (winningTrades / completedTrades) * 100 : 0;
  const totalPnl = realizedPnl + unrealizedPnl;
  
  // Update the summary display
  document.getElementById('totalTradesCount').textContent = totalTrades;
  document.getElementById('totalVolume').textContent = formatCurrency(totalVolume);
  document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
  document.getElementById('realizedPnl').textContent = formatCurrency(realizedPnl);
  document.getElementById('unrealizedPnl').textContent = formatCurrency(unrealizedPnl);
  document.getElementById('totalPnl').textContent = formatCurrency(totalPnl);
  
  // Update summary card styling based on P&L
  updateSummaryCardStyling('realizedPnlCard', realizedPnl);
  updateSummaryCardStyling('unrealizedPnlCard', unrealizedPnl);
  updateSummaryCardStyling('totalPnlCard', totalPnl);
}

// Update summary card styling
function updateSummaryCardStyling(cardId, value) {
  const card = document.getElementById(cardId);
  const valueElement = card.querySelector('.metric-value');
  
  // Remove existing P&L classes
  valueElement.classList.remove('pnl-positive', 'pnl-negative', 'pnl-neutral');
  
  // Add appropriate class based on value
  if (value > 0) {
    valueElement.classList.add('pnl-positive');
  } else if (value < 0) {
    valueElement.classList.add('pnl-negative');
  } else {
    valueElement.classList.add('pnl-neutral');
  }
}

// Filter trades based on search term
function filterTrades(searchTerm) {
  if (!searchTerm) {
    displayTrades(tradesData);
    return;
  }
  
  const filtered = tradesData.filter(trade => {
    const searchLower = searchTerm.toLowerCase();
    return (
      (trade.symbol && trade.symbol.toLowerCase().includes(searchLower)) ||
      (trade.pair && trade.pair.toLowerCase().includes(searchLower)) ||
      (trade.side && trade.side.toLowerCase().includes(searchLower)) ||
      (trade.type && trade.type.toLowerCase().includes(searchLower)) ||
      (trade.status && trade.status.toLowerCase().includes(searchLower))
    );
  });
  
  displayTrades(filtered);
}

// Refresh trades data
function refreshTrades() {
  loadTrades();
  loadErrors();
  if (window.LegacyCoinTrader && window.LegacyCoinTrader.showToast) {
    window.LegacyCoinTrader.showToast('Trades refreshed', 'success');
  }
}

// Export trades to CSV
function exportTrades() {
  if (tradesData.length === 0) {
    if (window.LegacyCoinTrader && window.LegacyCoinTrader.showToast) {
      window.LegacyCoinTrader.showToast('No trades to export', 'warning');
    }
    return;
  }
  
  // Create CSV content
  const headers = ['Date/Time', 'Symbol', 'Type', 'Amount', 'Price', 'Total', 'Status', 'P&L'];
  const csvContent = [
    headers.join(','),
    ...tradesData.map(trade => [
      new Date(trade.timestamp || trade.date || Date.now()).toISOString(),
      trade.symbol || trade.pair || '',
      trade.side || trade.type || '',
      trade.amount || trade.quantity || '',
      trade.price || trade.execution_price || '',
      (trade.amount || trade.quantity || 0) * (trade.price || trade.execution_price || 0),
      trade.status || '',
      trade.pnl || ''
    ].join(','))
  ].join('\n');
  
  // Download the CSV file
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  if (window.LegacyCoinTrader && window.LegacyCoinTrader.showToast) {
    window.LegacyCoinTrader.showToast('Trades exported successfully', 'success');
  }
}

// View trade details (placeholder function)
function viewTradeDetails(tradeId) {
  // This would typically open a modal with detailed trade information
  if (window.LegacyCoinTrader && window.LegacyCoinTrader.showToast) {
    window.LegacyCoinTrader.showToast(`Viewing details for trade: ${tradeId}`, 'info');
  }
}

// Utility functions for formatting
function formatNumber(num) {
  if (typeof num !== 'number' || isNaN(num)) return '0';
  return num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 8 });
}

function formatCurrency(num) {
  if (typeof num !== 'number' || isNaN(num)) return '$0.00';
  return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
</script>

{% endblock %}
