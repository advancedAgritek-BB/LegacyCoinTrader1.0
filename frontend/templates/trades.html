{% extends "base.html" %}

{% block content %}
<div class="trades-page fade-in">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-exchange-alt"></i>
            Trading History
          </h5>
        </div>
        <div class="card-body">
          <div class="trades-controls mb-3">
            <div class="row">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" class="form-control" id="tradeSearch" placeholder="Search trades...">
                </div>
              </div>
              <div class="col-md-6 text-end">
                <button class="btn btn-outline-primary" onclick="refreshTrades()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary" onclick="exportTrades()">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table" id="tradesTable">
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Symbol</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Price</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tradesTableBody">
                <!-- Trades will be loaded here -->
              </tbody>
            </table>
          </div>
          
          <div class="trades-summary mt-3">
            <div class="row">
              <div class="col-md-3">
                <div class="summary-item">
                  <span class="summary-label">Total Trades:</span>
                  <span class="summary-value" id="totalTradesCount">0</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="summary-item">
                  <span class="summary-label">Total Volume:</span>
                  <span class="summary-value" id="totalVolume">$0.00</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="summary-item">
                  <span class="summary-label">Win Rate:</span>
                  <span class="summary-value" id="winRate">0%</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="summary-item">
                  <span class="summary-label">Total P&L:</span>
                  <span class="summary-value" id="totalPnl">$0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Errors Section -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">
            <i class="fas fa-exclamation-triangle"></i>
            Recent Errors
          </h5>
        </div>
        <div class="card-body">
          <div class="errors-container" id="errorsContainer">
            <!-- Errors will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let tradesData = [];
let errorsData = [];

// Initialize the trades page
document.addEventListener('DOMContentLoaded', function() {
  loadTrades();
  loadErrors();
  
  // Set up search functionality
  document.getElementById('tradeSearch').addEventListener('input', function(e) {
    filterTrades(e.target.value);
  });
});

// Load trades data
function loadTrades() {
  fetch('/trades_data')
    .then(response => response.json())
    .then(data => {
      tradesData = data;
      displayTrades(data);
      updateSummary(data);
    })
    .catch(error => {
      console.error('Error loading trades:', error);
      window.LegacyCoinTrader.showToast('Error loading trades', 'error');
    });
}

// Load errors
function loadErrors() {
  fetch('/trades_tail')
    .then(response => response.json())
    .then(data => {
      if (data.errors) {
        displayErrors(data.errors);
      }
    })
    .catch(error => {
      console.error('Error loading errors:', error);
    });
}

// Display trades in the table
function displayTrades(trades) {
  const tbody = document.getElementById('tradesTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (trades.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center text-muted py-4">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <br>No trades found
        </td>
      </tr>
    `;
    return;
  }
  
  trades.forEach(trade => {
    const row = createTradeRow(trade);
    tbody.appendChild(row);
  });
}

// Create a trade table row
function createTradeRow(trade) {
  const row = document.createElement('tr');
  
  // Format the trade data
  const date = new Date(trade.timestamp || trade.date || Date.now()).toLocaleString();
  const symbol = trade.symbol || trade.pair || 'N/A';
  const type = trade.side || trade.type || 'N/A';
  const amount = trade.amount || trade.quantity || 0;
  const price = trade.price || trade.execution_price || 0;
  const total = amount * price;
  const status = trade.status || 'completed';
  
  // Determine status badge class
  let statusClass = 'badge-info';
  if (status === 'completed') statusClass = 'badge-success';
  else if (status === 'failed') statusClass = 'badge-danger';
  else if (status === 'pending') statusClass = 'badge-warning';
  
  // Determine type badge class
  let typeClass = 'badge-secondary';
  if (type.toLowerCase() === 'buy') typeClass = 'badge-success';
  else if (type.toLowerCase() === 'sell') typeClass = 'badge-danger';
  
  row.innerHTML = `
    <td>${date}</td>
    <td><strong>${symbol}</strong></td>
    <td><span class="badge ${typeClass}">${type.toUpperCase()}</span></td>
    <td>${formatNumber(amount)}</td>
    <td>${formatCurrency(price)}</td>
    <td>${formatCurrency(total)}</td>
    <td><span class="badge ${statusClass}">${status}</span></td>
    <td>
      <button class="btn btn-sm btn-outline-primary" onclick="viewTradeDetails('${trade.id || trade.timestamp}')">
        <i class="fas fa-eye"></i>
      </button>
    </td>
  `;
  
  return row;
}

// Display errors
function displayErrors(errors) {
  const container = document.getElementById('errorsContainer');
  if (!container) return;
  
  if (!errors || errors.trim() === '') {
    container.innerHTML = `
      <div class="text-center text-muted py-3">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <br>No errors found
      </div>
    `;
    return;
  }
  
  const errorLines = errors.split('\n').filter(line => line.trim());
  let html = '';
  
  errorLines.forEach(line => {
    if (line.trim()) {
      html += `
        <div class="error-item">
          <i class="fas fa-exclamation-circle text-danger"></i>
          <span class="error-text">${line}</span>
        </div>
      `;
    }
  });
  
  container.innerHTML = html;
}

// Update summary statistics
function updateSummary(trades) {
  const totalTrades = trades.length;
  const totalVolume = trades.reduce((sum, trade) => {
    const amount = trade.amount || trade.quantity || 0;
    const price = trade.price || trade.execution_price || 0;
    return sum + (amount * price);
  }, 0);
  
  // Calculate win rate (simplified - you might want to implement your own logic)
  const winningTrades = trades.filter(trade => {
    // This is a placeholder - implement your own win/loss logic
    return trade.pnl > 0;
  }).length;
  const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
  
  // Calculate total P&L
  const totalPnl = trades.reduce((sum, trade) => {
    return sum + (trade.pnl || 0);
  }, 0);
  
  // Update the summary display
  document.getElementById('totalTradesCount').textContent = totalTrades;
  document.getElementById('totalVolume').textContent = formatCurrency(totalVolume);
  document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
  document.getElementById('totalPnl').textContent = formatCurrency(totalPnl);
  
  // Color code the P&L
  const pnlElement = document.getElementById('totalPnl');
  if (totalPnl > 0) {
    pnlElement.className = 'summary-value text-success';
  } else if (totalPnl < 0) {
    pnlElement.className = 'summary-value text-danger';
  } else {
    pnlElement.className = 'summary-value text-muted';
  }
}

// Filter trades based on search term
function filterTrades(searchTerm) {
  if (!searchTerm) {
    displayTrades(tradesData);
    return;
  }
  
  const filtered = tradesData.filter(trade => {
    const searchLower = searchTerm.toLowerCase();
    return (
      (trade.symbol && trade.symbol.toLowerCase().includes(searchLower)) ||
      (trade.pair && trade.pair.toLowerCase().includes(searchLower)) ||
      (trade.side && trade.side.toLowerCase().includes(searchLower)) ||
      (trade.type && trade.type.toLowerCase().includes(searchLower)) ||
      (trade.status && trade.status.toLowerCase().includes(searchLower))
    );
  });
  
  displayTrades(filtered);
}

// Refresh trades data
function refreshTrades() {
  loadTrades();
  loadErrors();
  window.LegacyCoinTrader.showToast('Trades refreshed', 'success');
}

// Export trades to CSV
function exportTrades() {
  if (tradesData.length === 0) {
    window.LegacyCoinTrader.showToast('No trades to export', 'warning');
    return;
  }
  
  // Create CSV content
  const headers = ['Date/Time', 'Symbol', 'Type', 'Amount', 'Price', 'Total', 'Status', 'P&L'];
  const csvContent = [
    headers.join(','),
    ...tradesData.map(trade => [
      new Date(trade.timestamp || trade.date || Date.now()).toISOString(),
      trade.symbol || trade.pair || '',
      trade.side || trade.type || '',
      trade.amount || trade.quantity || '',
      trade.price || trade.execution_price || '',
      (trade.amount || trade.quantity || 0) * (trade.price || trade.execution_price || 0),
      trade.status || '',
      trade.pnl || ''
    ].join(','))
  ].join('\n');
  
  // Download the CSV file
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  window.LegacyCoinTrader.showToast('Trades exported successfully', 'success');
}

// View trade details (placeholder function)
function viewTradeDetails(tradeId) {
  // This would typically open a modal with detailed trade information
  window.LegacyCoinTrader.showToast(`Viewing details for trade: ${tradeId}`, 'info');
}

// Auto-refresh every 30 seconds
setInterval(loadTrades, 30000);
</script>

<style>
.trades-controls {
  background: var(--bg-secondary);
  border-radius: 0.5rem;
  padding: 1rem;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 0.5rem;
  border: 1px solid var(--border-color);
}

.summary-label {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.summary-value {
  font-weight: 600;
  color: var(--text-primary);
}

.error-item {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 0.5rem;
  margin-bottom: 0.5rem;
  border-left: 3px solid var(--danger-color);
}

.error-text {
  color: var(--text-secondary);
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  line-height: 1.4;
}

.text-success { color: var(--success-color) !important; }
.text-danger { color: var(--danger-color) !important; }
.text-muted { color: var(--text-muted) !important; }
</style>
{% endblock %}
